name: Java CI com Maven

on:
  push:
    branches: [main, testedevalidacaoesistema]
  pull_request:
    branches: [main]

jobs:
  # 1. Job de Compila莽茫o (DEV)
  compilar-projeto:
    runs-on: ubuntu-latest
    environment:
      name: dev
    steps:
      - name: Realiza o checkout do reposit贸rio
        uses: actions/checkout@v4
      - name: Configura o JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'
          cache: maven
      - name: Compila o projeto
        run: mvn -B compile --file pom.xml

  # 2. Job de Testes de Compatibilidade Java - COM XVFB
  testes-compatibilidade-java:
    runs-on: ubuntu-latest
    environment:
      name: hmg
    needs: compilar-projeto
    strategy:
      fail-fast: false
      matrix:
        java-version: [ '8', '11', '17' ]

    # Servi莽o de Banco de Dados
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: admin
          MYSQL_DATABASE: db_escola
          MYSQL_USER: admin
          MYSQL_PASSWORD: admin
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping -u admin -padmin" --health-interval=10s --health-timeout=5s --health-retries=10

    steps:
      - name: Realiza o checkout
        uses: actions/checkout@v4

      - name: Configura o JDK ${{ matrix.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: 'temurin'
          cache: maven

      #Instala o Monitor Virtual (Xvfb)
      - name: Instalar Xvfb
        run: sudo apt-get update && sudo apt-get install -y xvfb

      - name: Instalar cliente MySQL
        run: sudo apt-get install -y default-mysql-client

      - name: Configurar Schema do Banco
        env:
          MYSQL_PWD: admin
        run: |
          sleep 10
          mysql -h 127.0.0.1 -u admin -padmin db_escola < schema.sql || mysql -h 127.0.0.1 -u admin -padmin db_escola < db_escola.sql

      - name: Testa o projeto e gera relat贸rios (com Xvfb)
        # Nota: As credenciais do banco s茫o configuradas nos testes via @BeforeAll
        # usando TelaLogin.userDB e TelaLogin.passwordDB (admin/admin)
        run: xvfb-run --auto-servernum mvn -B clean test surefire-report:report jacoco:report --file pom.xml

      - name: Preparar relat贸rios HTML com estilos
        if: always()
        run: |
          mkdir -p reports-html/surefire reports-html/jacoco
          # Copiar relat贸rio Surefire com estrutura de diret贸rios mantida
          if [ -f target/site/surefire-report.html ]; then
            cp target/site/surefire-report.html reports-html/surefire/
            # Copiar recursos CSS e imagens mantendo estrutura
            if [ -d target/site/css ]; then
              cp -r target/site/css reports-html/surefire/
            fi
            if [ -d target/site/images ]; then
              cp -r target/site/images reports-html/surefire/
            fi
          fi
          # Copiar relat贸rio JaCoCo completo com todos os recursos
          if [ -d target/site/jacoco ]; then
            cp -r target/site/jacoco/* reports-html/jacoco/
            # Garantir que os recursos do JaCoCo estejam presentes
            if [ -d target/site/jacoco/jacoco-resources ]; then
              cp -r target/site/jacoco/jacoco-resources reports-html/jacoco/ 2>/dev/null || true
            fi
          fi

      - name: Publicar Relat贸rio de Testes HTML (Surefire)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: relatorio-testes-java-${{ matrix.java-version }}
          path: reports-html/surefire/
          retention-days: 30
          if-no-files-found: ignore

      - name: Publicar Relat贸rio de Cobertura HTML (JaCoCo)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: relatorio-cobertura-java-${{ matrix.java-version }}
          path: reports-html/jacoco/
          retention-days: 30
          if-no-files-found: ignore

      - name: Publicar Relat贸rio XML de Cobertura (para SonarCloud)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: jacoco-xml-java-${{ matrix.java-version }}
          path: target/site/jacoco/jacoco.xml
          retention-days: 30
          if-no-files-found: ignore

  # 3. Job de An谩lise de Qualidade de C贸digo (SonarCloud)
  analise-qualidade-codigo:
    runs-on: ubuntu-latest
    needs: testes-compatibilidade-java
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    # Servi莽o de Banco de Dados
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: admin
          MYSQL_DATABASE: db_escola
          MYSQL_USER: admin
          MYSQL_PASSWORD: admin
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping -u admin -padmin" --health-interval=10s --health-timeout=5s --health-retries=10
    
    steps:
      - name: Realiza o checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Configura o JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'
          cache: maven
      - name: Cache SonarQube
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
      - name: Cache Maven
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
      
      - name: Instalar cliente MySQL
        run: sudo apt-get install -y default-mysql-client

      - name: Configurar Schema do Banco
        env:
          MYSQL_PWD: admin
        run: |
          sleep 10
          mysql -h 127.0.0.1 -u admin -padmin db_escola < schema.sql || mysql -h 127.0.0.1 -u admin -padmin db_escola < db_escola.sql
      
      - name: Executa testes e gera relat贸rios
        # Nota: As credenciais do banco s茫o configuradas nos testes via @BeforeAll
        # usando TelaLogin.userDB e TelaLogin.passwordDB (admin/admin)
        run: mvn -B clean test surefire-report:report jacoco:report --file pom.xml
      
      - name: Analisa com SonarCloud
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: mvn -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar -Dsonar.projectKey=jopnovais_a3_GQS_unisul -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml

  # 4. Job de Consolida莽茫o de Relat贸rios de Testes
  consolidar-relatorios-testes:
    runs-on: ubuntu-latest
    needs: testes-compatibilidade-java
    if: always()
    steps:
      - name: Baixar todos os relat贸rios de testes HTML
        uses: actions/download-artifact@v4
        with:
          pattern: relatorio-testes-*
          merge-multiple: false
          path: reports-consolidados/testes
      
      - name: Baixar todos os relat贸rios de cobertura HTML
        uses: actions/download-artifact@v4
        with:
          pattern: relatorio-cobertura-*
          merge-multiple: false
          path: reports-consolidados/cobertura
      
      - name: Organizar relat贸rios HTML consolidados
        if: always()
        run: |
          mkdir -p reports-consolidados/html/surefire reports-consolidados/html/jacoco
          # Copiar relat贸rios mantendo estrutura de diret贸rios para recursos CSS/JS
          if [ -d reports-consolidados/testes ]; then
            find reports-consolidados/testes -type f -name "*.html" -exec cp {} reports-consolidados/html/surefire/ \;
            find reports-consolidados/testes -type d -name "css" -exec cp -r {} reports-consolidados/html/surefire/ \;
            find reports-consolidados/testes -type d -name "images" -exec cp -r {} reports-consolidados/html/surefire/ \;
          fi
          if [ -d reports-consolidados/cobertura ]; then
            cp -r reports-consolidados/cobertura/* reports-consolidados/html/jacoco/ 2>/dev/null || true
          fi
          # Criar 铆ndice HTML simples para navega莽茫o
          cat > reports-consolidados/html/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Relat贸rios de Testes - SisUni</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
              h1 { color: #333; }
              .report-link { display: block; padding: 10px; margin: 5px 0; background: white; 
                            border-left: 4px solid #4CAF50; text-decoration: none; color: #333; }
              .report-link:hover { background: #f0f0f0; }
            </style>
          </head>
          <body>
            <h1>Relat贸rios de Testes - SisUni</h1>
            <a href="surefire/surefire-report.html" class="report-link"> Relat贸rio de Testes (Surefire)</a>
            <a href="jacoco/index.html" class="report-link"> Relat贸rio de Cobertura (JaCoCo)</a>
          </body>
          </html>
          EOF
      
      - name: Publicar Relat贸rios HTML Consolidados
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: relatorios-consolidados-html
          path: reports-consolidados/html/
          retention-days: 90
          if-no-files-found: ignore

  # 5. Job de Empacotamento da Aplica莽茫o (PRD)
  empacotar-aplicacao:
    runs-on: ubuntu-latest
    environment:
      name: prd
    needs: analise-qualidade-codigo
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Realiza o checkout
        uses: actions/checkout@v4
      - name: Configura o JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'
          cache: maven
      - name: Empacota o projeto
        run: mvn -B package --file pom.xml -DskipTests
      - name: Cria pasta de artefatos
        run: mkdir staging
      - name: Copia o JAR
        run: cp target/*jar-with-dependencies.jar staging
      - name: Publica o artefato
        uses: actions/upload-artifact@v4
        with:
          name: Package
          path: staging
          retention-days: 90