name: Java CI/CD (Dev, HMG, Prod)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:

  #----------------------------------------------
  # DEV — Compilação simples
  #----------------------------------------------
  DEV:
    name: DEV - Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "maven"

      - name: Compilar projeto (sem testes)
        run: mvn -B clean compile


  #----------------------------------------------
  # HMG — Executar testes + gerar cobertura + SonarCloud
  #----------------------------------------------
  HMG:
    name: HMG - Test + SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: DEV

    steps:
      - name: Checkout do código
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "maven"

      - name: Rodar Testes + Gerar JaCoCo
        run: mvn -B verify

      - name: Upload do relatório JaCoCo
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: target/site/jacoco/jacoco.xml
          if-no-files-found: error

      - name: Rodar análise SonarCloud (somente main)
        if: github.ref == 'refs/heads/main'
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mvn -B verify sonar:sonar \
            -Dsonar.projectKey=jopnovais_a3_GQS_unisul \
            -Dsonar.organization=jopnovais \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml


  #----------------------------------------------
  # PRD — Empacotamento + Release
  #----------------------------------------------
  PRD:
    name: PRD - Package + Release
    runs-on: ubuntu-latest
    needs: HMG
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "maven"

      - name: Empacotar o projeto
        run: mvn -B clean package -DskipTests

      - name: Criar pasta de artefatos
        run: mkdir -p staging

      - name: Copiar JAR final
        run: cp target/*jar-with-dependencies.jar staging/

      - name: Upload do artefato final
        uses: actions/upload-artifact@v4
        with:
          name: projeto-faculdade-jar
          path: staging

      - name: Download do JAR para Release
        if: github.event_name == 'workflow_dispatch'
        uses: actions/download-artifact@v4
        with:
          name: projeto-faculdade-jar

      - name: Criar Release no GitHub (Manual)
        if: github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: Release v1.0.${{ github.run_number }}
          body: "Release automática do projeto da faculdade."
          files: "*.jar"
