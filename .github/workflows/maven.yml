name: Java CI com Maven

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # 1. Job de Compila√ß√£o (DEV)
  compilar-projeto:
    runs-on: ubuntu-latest
    environment:
      name: dev
    steps:
      - name: Realiza o checkout do reposit√≥rio
        uses: actions/checkout@v4
      - name: Configura o JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'
          cache: maven
      - name: Compila o projeto
        run: mvn -B compile --file pom.xml

  # 2. Job de Testes de Compatibilidade Java - COM XVFB
  testes-compatibilidade-java:
    runs-on: ubuntu-latest
    environment:
      name: hmg
    needs: compilar-projeto
    strategy:
      fail-fast: false
      matrix:
        java-version: [ '8', '11', '17' ]

    # Servi√ßo de Banco de Dados
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: admin
          MYSQL_DATABASE: db_escola
          MYSQL_USER: admin
          MYSQL_PASSWORD: admin
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping -u admin -padmin" --health-interval=10s --health-timeout=5s --health-retries=10

    steps:
      - name: Realiza o checkout
        uses: actions/checkout@v4

      - name: Configura o JDK ${{ matrix.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: 'temurin'
          cache: maven

      #Instala o Monitor Virtual (Xvfb)
      - name: Instalar Xvfb
        run: sudo apt-get update && sudo apt-get install -y xvfb

      - name: Instalar cliente MySQL
        run: sudo apt-get install -y default-mysql-client

      - name: Configurar Schema do Banco
        env:
          MYSQL_PWD: admin
        run: |
          sleep 10
          mysql -h 127.0.0.1 -u admin -padmin db_escola < schema.sql || mysql -h 127.0.0.1 -u admin -padmin db_escola < db_escola.sql

      - name: Testa o projeto e gera relat√≥rios (com Xvfb)
        # Nota: As credenciais do banco s√£o configuradas nos testes via @BeforeAll
        # usando TelaLogin.userDB e TelaLogin.passwordDB (admin/admin)
        run: xvfb-run --auto-servernum mvn -B clean test surefire-report:report jacoco:report --file pom.xml

      - name: Preparar relat√≥rios HTML com estilos para consolida√ß√£o
        if: always()
        run: |
          mkdir -p reports-html/surefire reports-html/jacoco
          # Copiar relat√≥rio Surefire com estrutura de diret√≥rios mantida
          if [ -f target/site/surefire-report.html ]; then
            cp target/site/surefire-report.html reports-html/surefire/
            # Copiar recursos CSS e imagens mantendo estrutura
            if [ -d target/site/css ]; then
              cp -r target/site/css reports-html/surefire/
            fi
            if [ -d target/site/images ]; then
              cp -r target/site/images reports-html/surefire/
            fi
          fi
          # Copiar relat√≥rio JaCoCo completo com todos os recursos
          if [ -d target/site/jacoco ]; then
            cp -r target/site/jacoco/* reports-html/jacoco/
            # Garantir que os recursos do JaCoCo estejam presentes
            if [ -d target/site/jacoco/jacoco-resources ]; then
              cp -r target/site/jacoco/jacoco-resources reports-html/jacoco/ 2>/dev/null || true
            fi
          fi

      - name: Publicar relat√≥rios para consolida√ß√£o
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: relatorios-java-${{ matrix.java-version }}
          path: reports-html/
          retention-days: 7
          if-no-files-found: ignore

      - name: Publicar Relat√≥rio XML de Cobertura (para SonarCloud)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: jacoco-xml-java-${{ matrix.java-version }}
          path: target/site/jacoco/jacoco.xml
          retention-days: 30
          if-no-files-found: ignore

  # 3. Job de An√°lise de Qualidade de C√≥digo (SonarCloud)
  analise-qualidade-codigo:
    runs-on: ubuntu-latest
    needs: consolidar-relatorios-testes
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/testedevalidacaoesistema')
    
    steps:
      - name: Realiza o checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Configura o JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: maven
      - name: Cache SonarQube
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
      - name: Cache Maven
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
      
      - name: Baixar relat√≥rio XML de cobertura do Java 8
        uses: actions/download-artifact@v4
        with:
          pattern: jacoco-xml-java-8
          path: jacoco-xml
      
      - name: Preparar relat√≥rio XML de cobertura para SonarCloud
        if: always()
        run: |
          # Procurar o arquivo jacoco.xml nos artefatos baixados
          mkdir -p target/site/jacoco
          if [ -f jacoco-xml/jacoco-xml-java-8/jacoco.xml ]; then
            cp jacoco-xml/jacoco-xml-java-8/jacoco.xml target/site/jacoco/jacoco.xml
            echo "‚úÖ Arquivo jacoco.xml encontrado e copiado"
          elif [ -f jacoco-xml/jacoco.xml ]; then
            cp jacoco-xml/jacoco.xml target/site/jacoco/jacoco.xml
            echo "‚úÖ Arquivo jacoco.xml encontrado e copiado"
          else
            echo "‚ö†Ô∏è Aviso: Arquivo jacoco.xml n√£o encontrado, SonarCloud pode n√£o ter dados de cobertura"
            # Criar arquivo vazio para evitar erro
            touch target/site/jacoco/jacoco.xml
          fi
      
      - name: Compilar projeto para an√°lise SonarCloud
        run: mvn -B clean compile --file pom.xml
      
      - name: Analisa com SonarCloud
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: mvn -B org.sonarsource.scanner.maven:sonar-maven-plugin:sonar -Dsonar.projectKey=jopnovais_a3_GQS_unisul -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml -DskipTests

  # 4. Job de Consolida√ß√£o de Relat√≥rios de Testes
  consolidar-relatorios-testes:
    runs-on: ubuntu-latest
    needs: testes-compatibilidade-java
    if: always()
    steps:
      - name: Baixar todos os relat√≥rios HTML de todas as vers√µes Java
        uses: actions/download-artifact@v4
        with:
          pattern: relatorios-java-*
          merge-multiple: false
          path: reports-consolidados
      
      - name: Organizar relat√≥rios HTML consolidados
        if: always()
        run: |
          mkdir -p reports-consolidados/html/surefire reports-consolidados/html/jacoco
          
          # Processar relat√≥rios de todas as vers√µes Java
          for java_dir in reports-consolidados/relatorios-java-*/; do
            if [ -d "$java_dir" ]; then
              java_version=$(basename "$java_dir" | sed 's/relatorios-java-//')
              
              # Copiar relat√≥rios Surefire (usar o do Java 8 como principal)
              if [ "$java_version" = "8" ] && [ -f "$java_dir/surefire/surefire-report.html" ]; then
                cp "$java_dir/surefire/surefire-report.html" reports-consolidados/html/surefire/
                if [ -d "$java_dir/surefire/css" ]; then
                  cp -r "$java_dir/surefire/css" reports-consolidados/html/surefire/
                fi
                if [ -d "$java_dir/surefire/images" ]; then
                  cp -r "$java_dir/surefire/images" reports-consolidados/html/surefire/
                fi
              fi
              
              # Copiar relat√≥rios JaCoCo (usar o do Java 8 como principal)
              if [ "$java_version" = "8" ] && [ -d "$java_dir/jacoco" ]; then
                cp -r "$java_dir/jacoco"/* reports-consolidados/html/jacoco/ 2>/dev/null || true
              fi
            fi
          done
          
          # Criar √≠ndice HTML estilizado para navega√ß√£o
          cat > reports-consolidados/html/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="pt-BR">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Relat√≥rios de Testes - SisUni</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body { 
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 40px 20px;
              }
              .container {
                max-width: 800px;
                margin: 0 auto;
                background: white;
                border-radius: 12px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                overflow: hidden;
              }
              .header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 30px;
                text-align: center;
              }
              .header h1 {
                font-size: 28px;
                margin-bottom: 10px;
              }
              .header p {
                opacity: 0.9;
                font-size: 14px;
              }
              .content {
                padding: 30px;
              }
              .report-link {
                display: flex;
                align-items: center;
                padding: 20px;
                margin: 15px 0;
                background: #f8f9fa;
                border-left: 5px solid #4CAF50;
                text-decoration: none;
                color: #333;
                border-radius: 8px;
                transition: all 0.3s ease;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
              }
              .report-link:hover {
                background: #e9ecef;
                transform: translateX(5px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.15);
              }
              .report-link .icon {
                font-size: 32px;
                margin-right: 15px;
              }
              .report-link .text {
                flex: 1;
              }
              .report-link .title {
                font-size: 18px;
                font-weight: 600;
                margin-bottom: 5px;
              }
              .report-link .description {
                font-size: 14px;
                color: #666;
              }
              .footer {
                text-align: center;
                padding: 20px;
                color: #666;
                font-size: 12px;
                border-top: 1px solid #e9ecef;
              }
            </style>
          </head>
          <body>
            <div class="container">
              <div class="header">
                <h1>üìä Relat√≥rios de Testes</h1>
                <p>Sistema de Gerenciamento Universit√°rio - SisUni</p>
              </div>
              <div class="content">
                <a href="surefire/surefire-report.html" class="report-link">
                  <span class="icon">üìã</span>
                  <div class="text">
                    <div class="title">Relat√≥rio de Testes (Surefire)</div>
                    <div class="description">Visualize todos os testes executados, resultados e estat√≠sticas</div>
                  </div>
                </a>
                <a href="jacoco/index.html" class="report-link">
                  <span class="icon">üìà</span>
                  <div class="text">
                    <div class="title">Relat√≥rio de Cobertura (JaCoCo)</div>
                    <div class="description">An√°lise detalhada da cobertura de c√≥digo por pacote, classe e m√©todo</div>
                  </div>
                </a>
              </div>
              <div class="footer">
                Gerado automaticamente pelo GitHub Actions
              </div>
            </div>
          </body>
          </html>
          EOF
      
      - name: Publicar Relat√≥rio HTML Consolidado
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: relatorio-consolidado-html
          path: reports-consolidados/html/
          retention-days: 90
          if-no-files-found: ignore

  # 5. Job de Empacotamento da Aplica√ß√£o (PRD)
  empacotar-aplicacao:
    runs-on: ubuntu-latest
    environment:
      name: prd
    needs: analise-qualidade-codigo
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/testedevalidacaoesistema')
    steps:
      - name: Realiza o checkout
        uses: actions/checkout@v4
      - name: Configura o JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'
          cache: maven
      - name: Empacota o projeto
        run: mvn -B package --file pom.xml -DskipTests
      - name: Cria pasta de artefatos
        run: mkdir staging
      - name: Copia o JAR
        run: cp target/*jar-with-dependencies.jar staging
      - name: Publica o artefato
        uses: actions/upload-artifact@v4
        with:
          name: Package
          path: staging
          retention-days: 90