name: Java CI/CD (Dev, HML, Prod)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  #----------------------------------------------
  # 1. AMBIENTE DEV: CompilaÃ§Ã£o
  #----------------------------------------------
  build-dev:
    name: 1. Build (DEV)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: "8"
          distribution: "temurin"
          cache: "maven"

      - name: Compilar o projeto
        run: mvn -B clean compile

  #----------------------------------------------
  # 2. AMBIENTE HML: Testes com mÃºltiplas versÃµes Java
  #----------------------------------------------
  build-hml:
    name: 2. Test (HML) - Java ${{ matrix.java-version }}
    runs-on: ubuntu-latest
    needs: build-dev
    strategy:
      fail-fast: false
      matrix:
        java-version: ["8", "11", "17"]

    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar JDK ${{ matrix.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: "temurin"
          cache: "maven"

      - name: Instalar Xvfb
        run: sudo apt-get update && sudo apt-get install -y xvfb

      - name: Compilar e Rodar Testes com JaCoCo (Xvfb)
        run: xvfb-run --auto-servernum mvn -B clean verify -Dmaven.test.failure.ignore=true

      - name: Upload RelatÃ³rio JaCoCo
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report-${{ matrix.java-version }}
          path: target/site/jacoco/jacoco.xml
          if-no-files-found: ignore

  #----------------------------------------------
  # 3. AMBIENTE DEV: AnÃ¡lise SonarCloud
  #----------------------------------------------
  analyze-sonar:
    name: 3. SonarCloud Analysis (somente main)
    runs-on: ubuntu-latest
    needs: build-hml
    if: github.event_name == 'push' || github.event_name == 'pull_request'

    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configurar JDK 17 (para Sonar)
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "maven"

      - name: Compilar o projeto
        run: mvn -B clean compile test-compile

      - name: Detectar tipo de branch
        id: branch-info
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ] && [ "${{ github.event_name }}" == "push" ]; then
            echo "is_main=true" >> $GITHUB_OUTPUT
            echo "Branch main detectada (push direto) - aplicando Quality Gate com 80% de cobertura"
          else
            echo "is_main=false" >> $GITHUB_OUTPUT
            if [ "${{ github.event_name }}" == "pull_request" ]; then
              echo "Pull Request detectado - anÃ¡lise sem exigÃªncia de cobertura"
            else
              echo "Branch de desenvolvimento detectada - anÃ¡lise sem exigÃªncia de cobertura"
            fi
          fi

      - name: Download RelatÃ³rio JaCoCo (apenas para main)
        if: steps.branch-info.outputs.is_main == 'true'
        uses: actions/download-artifact@v4
        with:
          name: jacoco-report-17
          path: .

      - name: Preparar RelatÃ³rio JaCoCo (apenas para main)
        if: steps.branch-info.outputs.is_main == 'true'
        run: |
          mkdir -p target/site/jacoco
          if [ -f jacoco.xml ]; then
            cp jacoco.xml target/site/jacoco/jacoco.xml
          fi

      - name: Cache SonarCloud
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Analisar com SonarCloud
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ steps.branch-info.outputs.is_main }}" == "true" ]; then
            echo "ðŸ“Š Branch main detectada â†’ Quality Gate rigoroso (80% cobertura exigida)"
            mvn -B verify sonar:sonar \
              -Dsonar.projectKey=jopnovais_a3_GQS_unisul \
              -Dsonar.organization=jopnovais \
              -Dsonar.host.url=https://sonarcloud.io \
              -Dsonar.qualitygate.wait=true \
              -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml
          else
            echo "ðŸ§ª Branch de desenvolvimento detectada â†’ AnÃ¡lise sem exigÃªncia de cobertura"
            mvn -B verify sonar:sonar \
              -Dsonar.projectKey=jopnovais_a3_GQS_unisul \
              -Dsonar.organization=jopnovais \
              -Dsonar.host.url=https://sonarcloud.io \
              -Dsonar.qualitygate.wait=false
          fi

  #----------------------------------------------
  # 4. AMBIENTE PRD: Empacotamento
  #----------------------------------------------
  build-prd:
    name: 4. Package (PRD)
    runs-on: ubuntu-latest
    needs: analyze-sonar
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar JDK 8 (para build final)
        uses: actions/setup-java@v4
        with:
          java-version: "8"
          distribution: "temurin"
          cache: "maven"

      - name: Empacotar o projeto
        run: mvn -B package -DskipTests

      - name: Criar pasta de artefatos
        run: mkdir -p staging

      - name: Copiar JAR
        run: cp target/*jar-with-dependencies.jar staging/

      - name: Upload do JAR como Artefato
        uses: actions/upload-artifact@v4
        with:
          name: projeto-faculdade-jar
          path: staging

  #----------------------------------------------
  # 5. AMBIENTE PRD: Criar Release (Manual)
  #----------------------------------------------
  create_release_prod:
    name: 5. Release (PRD) - Manual
    runs-on: ubuntu-latest
    needs: build-prd
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Download do JAR (Artefato da PRD)
        uses: actions/download-artifact@v4
        with:
          name: projeto-faculdade-jar

      - name: Criar Release no GitHub
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: Release v1.0.${{ github.run_number }}
          body: "Release automÃ¡tica do projeto da faculdade."
          files: "*.jar"
          draft: false
          prerelease: false
