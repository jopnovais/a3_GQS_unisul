name: Java CI/CD (Dev, HMG, Prod)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:

  #----------------------------------------------
  # 1. DEV — Compilação simples
  #----------------------------------------------
  build-dev:
    name: 1. Build (DEV)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "maven"

      - name: Compilar projeto (sem testes)
        run: mvn -B clean compile


  #----------------------------------------------
  # 2. HMG — Executar testes + gerar cobertura
  #----------------------------------------------
  build-hmg:
    name: 2. Test (HMG) - Java ${{ matrix.java-version }}
    runs-on: ubuntu-latest
    needs: build-dev

    strategy:
      fail-fast: false
      matrix:
        java-version: ["17"]  # Apenas 17 porque o Jacoco funciona melhor aqui

    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Configurar JDK ${{ matrix.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: "temurin"
          cache: "maven"

      - name: Rodar Testes + Gerar JaCoCo
        run: mvn -B verify

      - name: Upload do relatório JaCoCo
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: target/site/jacoco/jacoco.xml
          if-no-files-found: error


  #----------------------------------------------
  # 3. ANALISAR COM SONARCLOUD (somente main)
  #----------------------------------------------
  analyze-sonar:
    name: 3. SonarCloud Analysis (somente main)
    runs-on: ubuntu-latest
    needs: build-hmg
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout do código
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configurar JDK 17 (para Sonar)
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "maven"

      - name: Download relatório JaCoCo
        uses: actions/download-artifact@v4
        with:
          name: jacoco-report
          path: target/site/jacoco

      - name: Rodar análise Sonar com Quality Gate
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mvn -B sonar:sonar \
            -Dsonar.projectKey=jopnovais_a3_GQS_unisul \
            -Dsonar.organization=jopnovais \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.qualitygate.wait=true \
            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml


  #----------------------------------------------
  # 4. PRD — Empacotamento
  #----------------------------------------------
  build-prd:
    name: 4. Package (PRD)
    runs-on: ubuntu-latest
    needs: analyze-sonar
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "maven"

      - name: Empacotar o projeto
        run: mvn -B clean package -DskipTests

      - name: Criar pasta de artefatos
        run: mkdir -p staging

      - name: Copiar JAR final
        run: cp target/*jar-with-dependencies.jar staging/

      - name: Upload do artefato final
        uses: actions/upload-artifact@v4
        with:
          name: projeto-faculdade-jar
          path: staging


  #----------------------------------------------
  # 5. PROD — Criar Release manual
  #----------------------------------------------
  create_release_prod:
    name: 5. Release (PROD - Manual)
    runs-on: ubuntu-latest
    needs: build-prd
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Download do JAR
        uses: actions/download-artifact@v4
        with:
          name: projeto-faculdade-jar

      - name: Criar Release no GitHub
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: Release v1.0.${{ github.run_number }}
          body: "Release automática do projeto da faculdade."
          files: "*.jar"
